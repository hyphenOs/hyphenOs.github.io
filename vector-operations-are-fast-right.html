
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/font-awesome.min.css">





  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="Abhijit Gadgil" />
<meta name="description" content="Recently, I was looking at processing data from Pandas panel. I wanted to find out certain items in a Panel based on certain criteria on the minor axis. I worked with two flavors and the findings for different data-sets are quite interesting. Something that would definitely qualify as a learning." />
<meta name="keywords" content="pandas, numpy">
<meta property="og:site_name" content="hyphenOs {-Os} Blog"/>
<meta property="og:title" content="So Vector Operations Are Fast, Right?"/>
<meta property="og:description" content="Recently, I was looking at processing data from Pandas panel. I wanted to find out certain items in a Panel based on certain criteria on the minor axis. I worked with two flavors and the findings for different data-sets are quite interesting. Something that would definitely qualify as a learning."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/vector-operations-are-fast-right.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-08-02 00:00:00+05:30"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/abhijit-gadgil.html">
<meta property="article:section" content="Performance"/>
<meta property="article:tag" content="pandas"/>
<meta property="article:tag" content="numpy"/>
<meta property="og:image" content="/images/hyphenos-white.svg">

  <title>hyphenOs {-Os} Blog &ndash; So Vector Operations Are Fast, Right?</title>

</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/images/hyphenos-white.svg" alt="" title="">
      </a>
      <h1><a href=""></a></h1>


      <nav>
        <ul class="list">

          <li><a href="https://hyphenos.io/" target="_blank">hyphenOs Home</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://github.com/hyphenOs" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
    <h1 id="vector-operations-are-fast-right">So Vector Operations Are Fast, Right?</h1>
    <p>
          Posted on Wed 02 August 2017 in <a href="/category/performance.html">Performance</a>


    </p>
  </header>


  <div>
    <h3>A bit of a background</h3>
<p>I am developing a system of processing historical NSE equities data, where I want to look at <code>interesting</code> historical observations to be able to look at a subset of <code>all</code> stocks that are traded on NSE. While what those 'interesting' observations would be is going to be a function of an investors methodology, but a tool that helps you look at historical data in 'interactive' time frames (typically under 10 seconds) is going to be very handy.</p>
<p>Finally after nearly a few weeks of work, I managed to get a data that was in a form where I could do some experiments with this. The experiments are going to be along two axes - viz. from investment point of view (which the end users might be interested in) and from system point of view - to really answer the question in a reasonable manner - whether it will be really possible to make this available 'as a service' - more about that a bit later. Those curious about the code to download the data and process it can <a href="https://github.com/gabhijit/equities-data-utils">check it out here</a></p>
<h3>So coming to concrete problem</h3>
<p>I have a Pandas Panel that has got a list of 'stocks' as <code>items</code> and we have each <code>item</code> which has historical data as a data-frame with date as <code>index</code> and 'o,h,l,c' as columns. I wanted to filter based on simple criteria, say last 'close' is higher than previous 'close'.</p>
<p>One approach based on List Comprehensions is -</p>
<div class="highlight"><pre><span></span><span class="n">pan</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">scripdata_dict</span><span class="p">)</span>

<span class="c1"># All Items where the following condition is true and</span>
<span class="c1"># then use the boolean selectors to select items of our choice.</span>
<span class="n">sels</span> <span class="o">=</span> <span class="p">[</span><span class="n">pan</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pan</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pan</span><span class="p">]</span>
</pre></div>


<p>This somehow wasn't looking quite 'elegant' and certainly didn't look in the spirit of Pandas. I was pretty sure, there would be a faster, 'Vector' way of doing this. It took me a bit of time to find that out eventually as I am not quie an expert in Pandas. But eventually after struggling a bit I stumbled upon the following solution, that did what I was looking for -</p>
<div class="highlight"><pre><span></span><span class="c1"># Create a transpose of the Panel, now `items` become major axis.</span>
<span class="c1"># Select all rows such that the condition is true and then use</span>
<span class="c1"># the major axis (which is also an index) of the dataframe of `close` item.</span>

<span class="n">pan2</span> <span class="o">=</span> <span class="n">pan</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">pan2</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
<span class="n">cl2</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
<span class="n">pan11</span> <span class="o">=</span> <span class="n">pan</span><span class="p">[</span><span class="n">cl2</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</pre></div>


<p>This looked good, in theory and in practice too. I had a toy data that I was experimenting with just small data of 20 or so rows that helps you try out things without spending lot of time on loading data. And Voila, the second approach is about <em>20-40 times faster</em> than the first one. So the basic intuition is right, it's time to Declare Victory or Is it?.</p>
<p>Now somebody experienced with Pandas would have looked at it and asked 'How big is your data? Are you sure you want to do that? Did you RTFD?'.</p>
<p>So now we take the code and run it against 'real data' - about 3000 or so rows per dataframe in a Panel, and the same code now runs about <em>3-4 times slower</em>. What? Seriously? First impression is something else must be wrong. So I start looking at excuses, while the former I was running on my desktop, dedicated CPU and the latter I was running on a VPS, could that be a problem? This was clearly not an Apples-to-Apples comparison. So then I experiment with this 'small data' on the VPS, still the results are about the same. So we can eliminate that as a problem. Clearly size wise, the first one was about 2-3MB and the latter one was about 700MB. Hint, somewhere the Cache effects are coming into play?</p>
<p>The next quest was - how do I find out? My first (and quite wrong at that honestly) effort would be to use the <code>dtrace</code> support in Python and use some <code>perf</code> counters or tracing tools from the <a href="https://github.com/iovisor/bcc">bcc</a> to find out. Thankfully, that support is not there in Python 2.7 I am havingon my Ubuntu machine. So what next? Let's run Python's native profilers and find out. Is the intuition even correct? So ran a simple profiling experiment by using the <code>cProfile</code> and <code>pstats</code>. The code looks like following - fairly straight forward.</p>
<p>For the 'Vector' method -</p>
<div class="highlight"><pre><span></span><span class="n">then0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
<span class="n">pr</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="n">pan2</span> <span class="o">=</span> <span class="n">pan</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">pan2</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
<span class="n">cl2</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="n">cl</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cl</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
<span class="n">pan11</span> <span class="o">=</span> <span class="n">pan</span><span class="p">[</span><span class="n">cl2</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

<span class="n">pr</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
<span class="n">pr</span><span class="o">.</span><span class="n">dump_stats</span><span class="p">(</span><span class="s1">&#39;vector_stats.out&#39;</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>

<span class="c1"># Sort stats by cumulative and print only top 10%</span>
<span class="n">sort_by</span> <span class="o">=</span> <span class="s1">&#39;cumulative&#39;</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span>
<span class="n">ps</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ps</span><span class="o">.</span><span class="n">print_callers</span><span class="p">()</span>
<span class="n">now0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>


<p>and for the 'List Comprehension' method -</p>
<div class="highlight"><pre><span></span><span class="n">then0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
<span class="n">pr</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="n">sels</span> <span class="o">=</span> <span class="p">[</span><span class="n">pan</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pan</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pan</span><span class="p">]</span>

<span class="n">pr</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
<span class="n">pr</span><span class="o">.</span><span class="n">dump_stats</span><span class="p">(</span><span class="s1">&#39;lc.stats&#39;</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>

<span class="c1"># Sort stats by cumulative and print only top 10%</span>
<span class="n">sort_by</span> <span class="o">=</span> <span class="s1">&#39;cumulative&#39;</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span>
<span class="n">ps</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">now0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>


<p>Here are the actual Profiling outputs for run on 'small data'.</p>
<p>For the List Comprehension method -</p>
<div class="highlight"><pre><span></span><span class="m">0</span>.729673147202
<span class="m">734</span>
         <span class="m">552007</span> <span class="k">function</span> calls <span class="o">(</span><span class="m">533140</span> primitive calls<span class="o">)</span> in <span class="m">0</span>.704 seconds

   Ordered by: cumulative <span class="nb">time</span>
   List reduced from <span class="m">129</span> to <span class="m">13</span> due to restriction &lt;<span class="m">0</span>.1&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno<span class="o">(</span><span class="k">function</span><span class="o">)</span>
     <span class="m">6288</span>    <span class="m">0</span>.017    <span class="m">0</span>.000    <span class="m">0</span>.472    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/generic.py:1640<span class="o">(</span>_get_item_cache<span class="o">)</span>
     <span class="m">3144</span>    <span class="m">0</span>.014    <span class="m">0</span>.000    <span class="m">0</span>.361    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:280<span class="o">(</span>__getitem__<span class="o">)</span>
     <span class="m">3144</span>    <span class="m">0</span>.003    <span class="m">0</span>.000    <span class="m">0</span>.334    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/generic.py:1637<span class="o">(</span>__getitem__<span class="o">)</span>
     <span class="m">1572</span>    <span class="m">0</span>.009    <span class="m">0</span>.000    <span class="m">0</span>.282    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:558<span class="o">(</span>_box_item_values<span class="o">)</span>
     <span class="m">1572</span>    <span class="m">0</span>.012    <span class="m">0</span>.000    <span class="m">0</span>.250    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/frame.py:261<span class="o">(</span>__init__<span class="o">)</span>
     <span class="m">1572</span>    <span class="m">0</span>.014    <span class="m">0</span>.000    <span class="m">0</span>.229    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/frame.py:413<span class="o">(</span>_init_ndarray<span class="o">)</span>
     <span class="m">1572</span>    <span class="m">0</span>.009    <span class="m">0</span>.000    <span class="m">0</span>.181    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:4283<span class="o">(</span>create_block_manager_from_blocks<span class="o">)</span>
     <span class="m">3144</span>    <span class="m">0</span>.008    <span class="m">0</span>.000    <span class="m">0</span>.176    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/series.py:598<span class="o">(</span>__getitem__<span class="o">)</span>
     <span class="m">3144</span>    <span class="m">0</span>.012    <span class="m">0</span>.000    <span class="m">0</span>.166    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/frame.py:1940<span class="o">(</span>__getitem__<span class="o">)</span>
     <span class="m">3144</span>    <span class="m">0</span>.014    <span class="m">0</span>.000    <span class="m">0</span>.166    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/indexes/datetimes.py:1358<span class="o">(</span>get_value<span class="o">)</span>
     <span class="m">1572</span>    <span class="m">0</span>.010    <span class="m">0</span>.000    <span class="m">0</span>.148    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:2779<span class="o">(</span>__init__<span class="o">)</span>
     <span class="m">3144</span>    <span class="m">0</span>.003    <span class="m">0</span>.000    <span class="m">0</span>.144    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/frame.py:1966<span class="o">(</span>_getitem_column<span class="o">)</span>
     <span class="m">3144</span>    <span class="m">0</span>.029    <span class="m">0</span>.000    <span class="m">0</span>.144    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/indexes/base.py:2454<span class="o">(</span>get_value<span class="o">)</span>
</pre></div>


<p>For the Vector method -</p>
<div class="highlight"><pre><span></span><span class="m">0</span>.0554749965668
<span class="m">734</span>
         <span class="m">7443</span> <span class="k">function</span> calls <span class="o">(</span><span class="m">7341</span> primitive calls<span class="o">)</span> in <span class="m">0</span>.026 seconds

   Ordered by: cumulative <span class="nb">time</span>
   List reduced from <span class="m">447</span> to <span class="m">45</span> due to restriction &lt;<span class="m">0</span>.1&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno<span class="o">(</span><span class="k">function</span><span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.012    <span class="m">0</span>.012 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:1202<span class="o">(</span>transpose<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.001    <span class="m">0</span>.001    <span class="m">0</span>.012    <span class="m">0</span>.012 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/generic.py:496<span class="o">(</span>transpose<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.008    <span class="m">0</span>.008 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/frame.py:1940<span class="o">(</span>__getitem__<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.007    <span class="m">0</span>.007 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/indexes/datetimelike.py:249<span class="o">(</span>__contains__<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.007    <span class="m">0</span>.007 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/indexes/datetimes.py:1401<span class="o">(</span>get_loc<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.007    <span class="m">0</span>.007 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/base.py:42<span class="o">(</span>__str__<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.007    <span class="m">0</span>.007 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/base.py:54<span class="o">(</span>__bytes__<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.007    <span class="m">0</span>.007 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/series.py:974<span class="o">(</span>__unicode__<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.007    <span class="m">0</span>.007 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/generic.py:3256<span class="o">(</span>values<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.007    <span class="m">0</span>.007 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:462<span class="o">(</span>as_matrix<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.007    <span class="m">0</span>.007 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:3438<span class="o">(</span>as_matrix<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.002    <span class="m">0</span>.002    <span class="m">0</span>.006    <span class="m">0</span>.006 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:3452<span class="o">(</span>_interleave<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.006    <span class="m">0</span>.006 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/series.py:993<span class="o">(</span>to_string<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.004    <span class="m">0</span>.004    <span class="m">0</span>.004    <span class="m">0</span>.004 <span class="o">{</span>method <span class="s1">&#39;copy&#39;</span> of <span class="s1">&#39;numpy.ndarray&#39;</span> objects<span class="o">}</span>
        <span class="m">2</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.004    <span class="m">0</span>.002 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:280<span class="o">(</span>__getitem__<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.004    <span class="m">0</span>.004 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/io/formats/format.py:243<span class="o">(</span>to_string<span class="o">)</span>
      <span class="m">7</span>/5    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.003    <span class="m">0</span>.001 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/indexing.py:1317<span class="o">(</span>__getitem__<span class="o">)</span>
        <span class="m">2</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">0</span>.003    <span class="m">0</span>.001 /path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:160<span class="o">(</span>get_values<span class="o">)</span>
        <span class="m">4</span>    <span class="m">0</span>.003    <span class="m">0</span>.001    <span class="m">0</span>.003    <span class="m">0</span>.001 <span class="o">{</span>method <span class="s1">&#39;astype&#39;</span> of <span class="s1">&#39;numpy.ndarray&#39;</span> objects<span class="o">}</span>

&lt;stripped-a-few-lines&gt;
</pre></div>


<p>So the data also - justifies the basic intuition, in the case of 'vector' method, there are about 7000 calls compared to about '500000' calls to functions, justifying that <em>may be</em> we are doing more work in the List Comprehensions method.</p>
<p>So why is this so bad? Let's see what it looks like on the real data. Spoiler Alert: A good observer would have noticed that <code>'copy' method of 'numpy.ndarray' objects</code> already.</p>
<p>Below is the profiling output on the actual data.</p>
<p>For the List Comprehension method -</p>
<div class="highlight"><pre><span></span><span class="m">1</span>.5659070015
<span class="m">689</span>
         <span class="m">550855</span> <span class="k">function</span> calls <span class="o">(</span><span class="m">532024</span> primitive calls<span class="o">)</span> in <span class="m">1</span>.542 seconds

   Ordered by: cumulative <span class="nb">time</span>
   List reduced from <span class="m">132</span> to <span class="m">13</span> due to restriction &lt;<span class="m">0</span>.1&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno<span class="o">(</span><span class="k">function</span><span class="o">)</span>
     <span class="m">6276</span>    <span class="m">0</span>.038    <span class="m">0</span>.000    <span class="m">1</span>.008    <span class="m">0</span>.000 /actual/path/to/data/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/generic.py:1640<span class="o">(</span>_get_item_cache<span class="o">)</span>
     <span class="m">3138</span>    <span class="m">0</span>.032    <span class="m">0</span>.000    <span class="m">0</span>.806    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:280<span class="o">(</span>__getitem__<span class="o">)</span>
     <span class="m">3138</span>    <span class="m">0</span>.008    <span class="m">0</span>.000    <span class="m">0</span>.736    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/generic.py:1637<span class="o">(</span>__getitem__<span class="o">)</span>
     <span class="m">1569</span>    <span class="m">0</span>.014    <span class="m">0</span>.000    <span class="m">0</span>.635    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:558<span class="o">(</span>_box_item_values<span class="o">)</span>
     <span class="m">1569</span>    <span class="m">0</span>.022    <span class="m">0</span>.000    <span class="m">0</span>.564    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/frame.py:261<span class="o">(</span>__init__<span class="o">)</span>
     <span class="m">1569</span>    <span class="m">0</span>.025    <span class="m">0</span>.000    <span class="m">0</span>.527    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/frame.py:413<span class="o">(</span>_init_ndarray<span class="o">)</span>
     <span class="m">1569</span>    <span class="m">0</span>.020    <span class="m">0</span>.000    <span class="m">0</span>.402    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:4283<span class="o">(</span>create_block_manager_from_blocks<span class="o">)</span>
     <span class="m">3138</span>    <span class="m">0</span>.017    <span class="m">0</span>.000    <span class="m">0</span>.397    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/series.py:598<span class="o">(</span>__getitem__<span class="o">)</span>
     <span class="m">3138</span>    <span class="m">0</span>.027    <span class="m">0</span>.000    <span class="m">0</span>.368    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/indexes/datetimes.py:1358<span class="o">(</span>get_value<span class="o">)</span>
     <span class="m">3138</span>    <span class="m">0</span>.024    <span class="m">0</span>.000    <span class="m">0</span>.340    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/frame.py:1940<span class="o">(</span>__getitem__<span class="o">)</span>
     <span class="m">3138</span>    <span class="m">0</span>.057    <span class="m">0</span>.000    <span class="m">0</span>.323    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/indexes/base.py:2454<span class="o">(</span>get_value<span class="o">)</span>
     <span class="m">3138</span>    <span class="m">0</span>.008    <span class="m">0</span>.000    <span class="m">0</span>.288    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/frame.py:1966<span class="o">(</span>_getitem_column<span class="o">)</span>
     <span class="m">1569</span>    <span class="m">0</span>.019    <span class="m">0</span>.000    <span class="m">0</span>.284    <span class="m">0</span>.000 /actual/path/to/data/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:2779<span class="o">(</span>__init__<span class="o">)</span>
</pre></div>


<p>and for the Vector method -</p>
<div class="highlight"><pre><span></span><span class="m">7</span>.15247297287
<span class="m">689</span>
         <span class="m">7443</span> <span class="k">function</span> calls <span class="o">(</span><span class="m">7341</span> primitive calls<span class="o">)</span> in <span class="m">7</span>.138 seconds

   Ordered by: cumulative <span class="nb">time</span>
   List reduced from <span class="m">447</span> to <span class="m">45</span> due to restriction &lt;<span class="m">0</span>.1&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno<span class="o">(</span><span class="k">function</span><span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">5</span>.000    <span class="m">5</span>.000 /home/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:1202<span class="o">(</span>transpose<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.349    <span class="m">0</span>.349    <span class="m">5</span>.000    <span class="m">5</span>.000 /home/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/generic.py:496<span class="o">(</span>transpose<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">2</span>.863    <span class="m">2</span>.863 /home/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/generic.py:3256<span class="o">(</span>values<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">2</span>.863    <span class="m">2</span>.863 /home/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:462<span class="o">(</span>as_matrix<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">2</span>.863    <span class="m">2</span>.863 /home/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:3438<span class="o">(</span>as_matrix<span class="o">)</span>
        <span class="m">1</span>    <span class="m">0</span>.644    <span class="m">0</span>.644    <span class="m">2</span>.863    <span class="m">2</span>.863 /home/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:3452<span class="o">(</span>_interleave<span class="o">)</span>
        <span class="m">2</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">2</span>.040    <span class="m">1</span>.020 /home/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/panel.py:280<span class="o">(</span>__getitem__<span class="o">)</span>
        <span class="m">2</span>    <span class="m">0</span>.000    <span class="m">0</span>.000    <span class="m">1</span>.818    <span class="m">0</span>.909 /home/gabhijit/equities-data-utils/venv/local/lib/python2.7/site-packages/pandas/core/internals.py:160<span class="o">(</span>get_values<span class="o">)</span>
        <span class="m">4</span>    <span class="m">1</span>.818    <span class="m">0</span>.454    <span class="m">1</span>.818    <span class="m">0</span>.454 <span class="o">{</span>method <span class="s1">&#39;astype&#39;</span> of <span class="s1">&#39;numpy.ndarray&#39;</span> objects<span class="o">}</span>
        <span class="m">1</span>    <span class="m">1</span>.787    <span class="m">1</span>.787    <span class="m">1</span>.787    <span class="m">1</span>.787 <span class="o">{</span>method <span class="s1">&#39;copy&#39;</span> of <span class="s1">&#39;numpy.ndarray&#39;</span> objects<span class="o">}</span>
</pre></div>


<p>Eureka! The <code>transpose</code> function has become extremely expensive for this big data. Note, the number of funtion calls is still about the same, about 7000 vs. 500000, but at-least some of the functions have become exensive and interestingly the total cost was actually growing sub-linearly for the List Comprehension method.</p>
<p>Now, when one looks at this data, it's clearly not that counter intuitive. We are doing a <code>memcpy</code> of a huge array in the <code>transpose</code> method and that's likely is a cause of real slowdown. While in the former case, there was still <code>memcpy</code>, but on a data that could probably fit easily in cache (or at-least was quite cache friendly) compared to this. Didn't they tell in networking don't do <code>memcpy</code> in the fast path?</p>
<p>We need to still follow this line of thought and find out more about what's happening under the hood. Some of the things that are worth experimenting include -</p>
<ol>
<li>double the data size and compute the fraction of time spent in <code>transpose</code> for every doubling and expect to see a knee somewhere.</li>
<li>Does that make sense with the cache size on my computer?</li>
<li>Indeed look at the <code>perf</code> counters and see some cache statistics.</li>
</ol>
<p>Will write a follow up on this to actually find out what the findings above are.</p>
<p>Few lessons learnt here -</p>
<ul>
<li>Just don't go by what theoretically makes sense. Know precisely what you are trying to do and what scale.</li>
<li>Simply - going by 'Vector Operations are Fast' so always use them, may not be the wisest choice.</li>
<li>RTFM - because clearly <a href="http://pandas.pydata.org/pandas-docs/version/0.20.3/generated/pandas.Panel.transpose.html">documentation on transpose</a> says, for Mixed-dtype data, will always result in a copy.</li>
<li>Sometimes not having an expert around is not a bad idea, because you develop better understanding by making mistakes.</li>
</ul>
<p>And a few collateral benefits -</p>
<ol>
<li>Had an actual use-case for studying <code>cProfile</code> rather than trying some simple 'hello world!' stuff.</li>
<li>Learnt about a beautiful tool <a href="https://github.com/jrfonseca/gprof2dot">gprof2dot</a>, when trying to find out more about the actual call-graphs and find out the culprits. It's worth checking out.</li>
</ol>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/pandas.html">pandas</a>
      <a href="/tag/numpy.html">numpy</a>
    </p>
  </div>




</article>

    <footer>
<p>&copy; hyphenOs Software Labs. Pvt. Ltd. </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " hyphenOs {-Os} Blog ",
  "url" : "",
  "image": "/images/hyphenos-white.svg",
  "description": ""
}
</script>
</body>
</html>